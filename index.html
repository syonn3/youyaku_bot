<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>文章要約Bot</title>
  <link rel="apple-touch-icon" href="logo.jpg" />

  <style>
    :root{
      --bg:#0b1220; --surface:#0f1a33; --surface-2:#0b162e;
      --border:#1c2a4a; --text:#e8ecf1; --muted:#9fb1c7;
      --accent:#2a5bd7; --danger:#e35d5d;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin:0; padding:16px; line-height:1.6;
    }
    h1{font-size:1.25rem; margin:0 0 12px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:12px;
      padding:12px;
    }

    /* 入力テキスト（全文スクロールで見える） */
    #input{
      width:100%;
      height:40vh;                 /* 画面の4割の高さ */
      resize:vertical;             /* 必要ならドラッグで伸縮 */
      background:var(--surface-2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      line-height:1.7;
      overflow:auto;               /* ← ペースト全文スクロール */
      white-space:pre-wrap;
    }

    /* 要約結果（長文もスクロール可能） */
    #summary{
      white-space:pre-wrap;
      background:var(--surface-2);
      border:1px solid var(--border);
      padding:12px; margin:12px 0; border-radius:10px;
      max-height:42vh;             /* 画面の約4割まで表示 */
      overflow:auto;               /* ← 要約も全文スクロール */
    }

    label{font-size:.95rem; color:var(--muted)}
    input[type="number"]{
      width:120px; padding:8px 10px;
      background:var(--surface-2); color:var(--text);
      border:1px solid var(--border); border-radius:8px;
    }
    .btn{
      background:var(--accent); color:#fff; border:none;
      padding:10px 14px; border-radius:10px; font-size:1rem;
    }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); }
    .btn.danger{ background:var(--danger); }
    .chip{
      border:1px solid var(--border); color:var(--text);
      background:transparent; padding:8px 10px; border-radius:999px; font-size:.95rem;
    }
    .chip[aria-pressed="true"]{ background:var(--surface-2); outline:2px solid var(--accent) }

    .hint{font-size:.85rem; color:var(--muted)}
    .small{font-size:.9rem}
  </style>
</head>
<body>
  <h1>文章要約Bot</h1>

  <!-- ---- 入力 ---- -->
  <div class="card" style="margin-bottom:12px">
    <div class="row" style="justify-content:space-between">
      <label class="small">下に本文をペースト（長文OK／スクロール可）</label>
      <button class="btn secondary small" onclick="pasteFromClipboard()">📋 ペースト</button>
    </div>
    <textarea id="input" placeholder="ここに記事や本文をそのまま貼り付け"></textarea>
  </div>

  <!-- ---- 設定（長さ指定）---- -->
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <span class="hint">長さ（目標文字数）:</span>
      <button class="chip" id="lenShort"  onclick="pickPreset(100)" aria-pressed="false">短: 50–100</button>
      <button class="chip" id="lenMid"    onclick="pickPreset(300)" aria-pressed="true">中: 200–400</button>
      <button class="chip" id="lenLong"   onclick="pickPreset(700)" aria-pressed="false">長: 600–800</button>
      <span class="hint">／ 直接指定:</span>
      <input id="charLimit" type="number" min="30" max="2000" step="10" value="300" inputmode="numeric" pattern="[0-9]*" />
      <span class="hint">文字</span>
    </div>
    <div class="hint" style="margin-top:6px">
      数字以外（「2,00」など）は自動で正規化します。実際の要約は±10〜15%の誤差を許容。
    </div>
  </div>

  <!-- ---- 操作 ---- -->
  <div class="row" style="margin-bottom:8px">
    <button class="btn" onclick="summarize()">🧠 要約する</button>
    <button class="btn secondary" onclick="clearAll()">🧹 クリア</button>
    <button class="btn" onclick="speakSummary()">🔊 読み上げ</button>
  </div>

  <!-- ---- 結果 ---- -->
  <div id="summary" aria-live="polite"></div>
  <div class="hint">※ デモ版はクライアント側で長さ調整を厳密化。本番APIでも同じ目標文字数を渡し、完了後に微調整します。</div>

  <script>
    // --- ユーティリティ ---
    function sanitizeNumberLike(v){
      // 全角→半角、カンマ・空白を除去して数値化
      const z2h = v.replace(/[０-９，、．．\s]/g, s=>{
        const code = s.charCodeAt(0);
        if (s === '，' || s === '、' || s === ',') return '';
        if (s === '．' || s === '。' || s === '.') return '';
        if (code >= 0xFF10 && code <= 0xFF19) return String.fromCharCode(code - 0xFF10 + 0x30);
        return '';
      }).replace(/[^\d]/g,'');
      return Number(z2h || 0);
    }
    function setPressed(id){
      ['lenShort','lenMid','lenLong'].forEach(k=>{
        document.getElementById(k).setAttribute('aria-pressed', k===id ? 'true' : 'false');
      });
    }
    function pickPreset(n){
      document.getElementById('charLimit').value = n;
      if (n<=120) setPressed('lenShort'); else if (n<=450) setPressed('lenMid'); else setPressed('lenLong');
    }

    async function pasteFromClipboard(){
      try{
        const text = await navigator.clipboard.readText();
        if(text){ document.getElementById('input').value = text; }
      }catch(e){
        alert('クリップボードから貼り付けできませんでした。長押し→ペーストを使ってください。');
      }
    }

    function clearAll(){
      document.getElementById('input').value = '';
      document.getElementById('summary').innerText = '';
    }

    // --- 要約（デモ用ローカル実装） ---
    function summarize(){
      const raw = document.getElementById('input').value.trim();
      if(!raw){ alert('本文をペーストしてください'); return; }

      // 文字数指定を正規化（例: "2,00" → 200）
      const rawLimit = document.getElementById('charLimit').value.toString();
      let limit = Number(rawLimit);
      if(!Number.isFinite(limit) || limit<=0){
        limit = sanitizeNumberLike(rawLimit);
      }
      if(!limit || limit<30){ limit = 300; document.getElementById('charLimit').value = 300; }

      // ここで本来はAPI要約を呼ぶ：
      // const ai = await callSummarizeAPI(raw, { targetChars: limit, style, ... });
      // 今はデモとして、本文を「段落→要点抽出→指定文字数に近づけて整形」
      const draft = heuristicSummarize(raw, limit);
      const tuned = lengthTuner(draft, limit);
      document.getElementById('summary').innerText = tuned;
    }

    // ざっくり要点抽出（行頭や「。」「・」「- 」などを頼りに分割→上位を採用）
    function heuristicSummarize(text, limit){
      // 改行正規化
      const t = text.replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n');
      // 候補文の切り出し
      let units = t
        .split(/(?<=[。！？\?])\s+|\n- |\n・|\n|\t/g)
        .map(s=>s.trim()).filter(Boolean);

      // 重複/ノイズ削り
      const seen = new Set();
      units = units.filter(s=>{
        const k = s.length>40 ? s.slice(0,40) : s;
        if(seen.has(k)) return false;
        seen.add(k);
        return s.length>1;
      });

      // 短い要素をまとめてスニペット化
      let out = '';
      for(const u of units){
        if(out.length + u.length + 1 > Math.max(1200, limit*3)) break; // 過剰連結防止
        out += (out ? '\n' : '') + (u.startsWith('・') || u.startsWith('-')? u : '・' + u);
      }
      if(!out) out = text.slice(0, Math.min(text.length, limit*2));
      return out;
    }

    // 目標文字数に合わせて微調整（±約15%に収める）
    function lengthTuner(text, target){
      const min = Math.round(target*0.85);
      const max = Math.round(target*1.15);

      // 近いならそのまま
      if(text.length>=min && text.length<=max) return text;

      if(text.length>max){
        // 文章末尾（句点/改行）で気持ちよく切る
        const cut = smartCut(text, max);
        return cut;
      }else{
        // 少ないとき：元テキストから追加で少し継ぎ足すのが本来だが、
        // デモでは冗長語を少し足して体裁を整える
        return padTo(text, min);
      }
    }

    function smartCut(text, max){
      if(text.length<=max) return text;
      const slice = text.slice(0, max);
      const p = Math.max(slice.lastIndexOf('。'), slice.lastIndexOf('\n'));
      return (p>0 ? slice.slice(0, p+1) : slice) + (p>0 ? '' : '…');
    }

    function padTo(text, min){
      if(text.length>=min) return text;
      const filler = '\n（要点を凝縮しています。詳細は原文をご確認ください。）';
      let out = text + filler;
      if(out.length<min) out = out + ' 追記: 概要の網羅を優先し、細部は省略。';
      return out;
    }

    // --- 音声読み上げ（据え置き） ---
    function speakSummary(){
      const text = document.getElementById('summary').innerText.trim();
      if(!text){ alert('要約文がありません'); return; }
      // 連続押下時に前の発話を止める
      if(speechSynthesis.speaking) speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      speechSynthesis.speak(utter);
    }

    // 初期ボタン状態
    pickPreset(300);
  </script>
</body>
</html>
