<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>文章要約Bot</title>
  <link rel="apple-touch-icon" href="logo.jpg" />
  <style>
    :root{
      --bg:#0b1220; --surface:#0f1a33; --surface-2:#0b162e;
      --border:#1c2a4a; --text:#e8ecf1; --muted:#9fb1c7;
      --accent:#2a5bd7; --danger:#e35d5d;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin:0; padding:16px; line-height:1.6;
    }
    h1{font-size:1.25rem; margin:0 0 12px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:12px;
      padding:12px; margin-bottom:12px;
    }
    .hint{font-size:.85rem; color:var(--muted)}
    .small{font-size:.9rem}

    /* URL入力 */
    #urlInput{
      flex:1 1 220px; min-width:220px;
      padding:10px 12px; border-radius:10px;
      background:var(--surface-2); color:var(--text);
      border:1px solid var(--border);
    }

    /* 入力テキスト（全文スクロール） */
    #input{
      width:100%; height:40vh; resize:vertical;
      background:var(--surface-2); color:var(--text);
      border:1px solid var(--border); border-radius:10px;
      padding:12px; line-height:1.7;
      overflow:auto; white-space:pre-wrap;
    }

    /* 要約結果（全文スクロール） */
    #summary{
      white-space:pre-wrap; background:var(--surface-2);
      border:1px solid var(--border); border-radius:10px;
      padding:12px; max-height:42vh; overflow:auto;
    }

    input[type="number"]{
      width:120px; padding:8px 10px;
      background:var(--surface-2); color:var(--text);
      border:1px solid var(--border); border-radius:8px;
    }
    .btn{
      background:var(--accent); color:#fff; border:none;
      padding:10px 14px; border-radius:10px; font-size:1rem;
    }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); }
    .btn.danger{ background:var(--danger); }

    /* 縦並びプリセット */
    .presets{
      display:flex; flex-direction:column; gap:8px; width:160px;
    }
    .chip{
      width:100%;
      text-align:left;
      border:1px solid var(--border); color:var(--text);
      background:transparent; padding:10px 12px; border-radius:10px; font-size:.95rem;
    }
    .chip[aria-pressed="true"]{ background:var(--surface-2); outline:2px solid var(--accent) }
  </style>
</head>
<body>
  <h1>文章要約Bot</h1>

  <!-- URL入力＆取得（必ず入力欄に流し込んでから要約） -->
  <div class="card">
    <div class="row">
      <input id="urlInput" type="url" placeholder="https:// から始まる要約したいページのURLを貼り付け" />
      <button class="btn" onclick="loadFromURL()">🌐 URLを要約</button>
    </div>
    <div class="hint" style="margin-top:6px">
      本文抽出は <code>r.jina.ai</code> を優先。ブロック時は本文をペーストしてください。
    </div>
  </div>

  <!-- 入力（ペースト） -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <label class="small">下に本文をペースト（長文OK／スクロール可）</label>
      <button class="btn secondary small" onclick="pasteFromClipboard()">📋 ペースト</button>
    </div>
    <textarea id="input" placeholder="ここに記事や本文をそのまま貼り付け"></textarea>
  </div>

  <!-- 設定（長さ指定：縦並び） -->
  <div class="card">
    <div class="row" style="align-items:flex-start">
      <div class="presets">
        <button class="chip" id="lenShort"  onclick="pickPreset(100)" aria-pressed="false">短: 50–100 文字</button>
        <button class="chip" id="lenMid"    onclick="pickPreset(300)" aria-pressed="true">中: 200–400 文字</button>
        <button class="chip" id="lenLong"   onclick="pickPreset(700)" aria-pressed="false">長: 600–800 文字</button>
      </div>
      <div>
        <div class="hint">直接指定:</div>
        <div class="row" style="margin-top:6px">
          <input id="charLimit" type="number" min="30" max="2000" step="10" value="300" inputmode="numeric" pattern="[0-9]*" />
          <span class="hint">文字</span>
        </div>
        <div class="hint" style="margin-top:6px">
          「2,00」「２００」などは自動で数値化。仕上がりは目標の ±10〜15% を目安に調整。
        </div>
      </div>
    </div>
  </div>

  <!-- 操作 -->
  <div class="row" style="margin-bottom:8px">
    <button class="btn" onclick="summarize()">🧠 要約する</button>
    <button class="btn secondary" onclick="clearAll()">🧹 クリア</button>
    <button class="btn" onclick="speakSummary()">🔊 読み上げ</button>
  </div>

  <!-- 結果 -->
  <div id="summary" aria-live="polite"></div>
  <div class="hint">※ 英文は画面側で簡易和文化します（本番はAPIで完全和訳）。</div>

  <script>
    // ===== URL → テキスト抽出 → 入力欄へ流し込み → 要約 =====
    async function loadFromURL(){
      const input = document.getElementById('urlInput').value.trim();
      const url = normalizeURL(input);
      if(!url){ alert('有効なURLを入力してください'); return; }

      const jinaEndpoint = "https://r.jina.ai/http://" + url.replace(/^https?:\/\//,'');
      try{
        const resp = await fetch(jinaEndpoint, { method:'GET' });
        if(resp.ok){
          const text = (await resp.text() || '').trim();
          if(text){
            document.getElementById('input').value = text;
            summarize();
            return;
          }
        }
        throw new Error('jina失敗');
      }catch(e){
        alert('本文取得に失敗しました。サイト側の制限の可能性があります。本文をペーストして要約してください。');
      }
    }

    function normalizeURL(str){
      if(!str) return '';
      let s = str.trim();
      if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
      try{ new URL(s); return s; }catch{ return ''; }
    }

    // ===== クリップボード貼り付け =====
    async function pasteFromClipboard(){
      try{
        const text = await navigator.clipboard.readText();
        if(text){ document.getElementById('input').value = text; }
      }catch(e){
        alert('クリップボードから貼り付けできませんでした。長押し→ペーストを使ってください。');
      }
    }

    // ===== UIユーティリティ =====
    function sanitizeNumberLike(v){
      const z2h = v.toString().replace(/[０-９，、．．\s]/g, s=>{
        const code = s.charCodeAt(0);
        if (s === '，' || s === '、' || s === ',') return '';
        if (s === '．' || s === '。' || s === '.') return '';
        if (code >= 0xFF10 && code <= 0xFF19) return String.fromCharCode(code - 0xFF10 + 0x30);
        return '';
      }).replace(/[^\d]/g,'');
      return Number(z2h || 0);
    }
    function setPressed(id){
      ['lenShort','lenMid','lenLong'].forEach(k=>{
        document.getElementById(k).setAttribute('aria-pressed', k===id ? 'true' : 'false');
      });
    }
    function pickPreset(n){
      document.getElementById('charLimit').value = n;
      if (n<=120) setPressed('lenShort'); else if (n<=450) setPressed('lenMid'); else setPressed('lenLong');
    }
    function clearAll(){
      document.getElementById('input').value = '';
      document.getElementById('summary').innerText = '';
    }

    // ===== 要約（入力欄→要約） =====
    function summarize(){
      const raw = document.getElementById('input').value.trim();
      if(!raw){ alert('本文を用意してください（URL取得 or ペースト）'); return; }
      summarizeText(raw);
    }

    // ===== 要約（テキスト→要約） =====
    function summarizeText(raw){
      const rawLimit = document.getElementById('charLimit').value.toString();
      let limit = Number(rawLimit);
      if(!Number.isFinite(limit) || limit<=0) limit = sanitizeNumberLike(rawLimit);
      if(!limit || limit<30){ limit = 300; document.getElementById('charLimit').value = 300; }

      const base = heuristicSummarize(raw, limit);
      const tuned = lengthTuner(base, limit);
      const jp = forceJapanese(tuned, raw);

      document.getElementById('summary').innerText = jp;
    }

    // ざっくり要点抽出（箇条書き風）
    function heuristicSummarize(text, limit){
      const t = text.replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n');
      let units = t.split(/(?<=[。\.！？\?])\s+|\n- |\n• |\n・|\n|\t/g)
                   .map(s=>s.trim()).filter(Boolean);

      const seen = new Set();
      units = units.filter(s=>{
        const k = s.length>60 ? s.slice(0,60) : s;
        if(seen.has(k)) return false; seen.add(k);
        return s.length>1;
      });

      let out = '';
      for(const u of units){
        if(out.length + u.length + 1 > Math.max(1200, limit*3)) break;
        out += (out ? '\n' : '') + (u.match(/^[-•・]/) ? u.replace(/^[-•]\s?/, '・') : '・' + u);
      }
      if(!out) out = text.slice(0, Math.min(text.length, limit*2));
      return out;
    }

    // 目標文字数に合わせて微調整（±約15%）
    function lengthTuner(text, target){
      const min = Math.round(target*0.85);
      const max = Math.round(target*1.15);
      if(text.length>=min && text.length<=max) return text;
      if(text.length>max) return smartCut(text, max);
      return padTo(text, min);
    }
    function smartCut(text, max){
      if(text.length<=max) return text;
      const slice = text.slice(0, max);
      const p = Math.max(slice.lastIndexOf('。'), slice.lastIndexOf('\n'), slice.lastIndexOf('. '));
      return (p>0 ? slice.slice(0, p+1) : slice) + (p>0 ? '' : '…');
    }
    function padTo(text, min){
      if(text.length>=min) return text;
      const filler = '\n（要点を凝縮しています。詳細は原文をご確認ください。）';
      let out = text + filler;
      if(out.length<min) out = out + ' 追記: 概要の網羅を優先し、細部は省略。';
      return out;
    }

    // 英文っぽい場合は見た目を和文化（簡易・画面側）
    function forceJapanese(summary, raw){
      const looksEnglish = /[A-Za-z]/.test(raw) && !/[ぁ-んァ-ン一-龥]/.test(raw.slice(0,500));
      if(!looksEnglish) return summary;

      let t = summary;
      // 記号・接続の和文化
      t = t.replace(/\n-/g,'\n・')
           .replace(/:\s*/g,'：')
           .replace(/;\s*/g,'；')
           .replace(/ - /g,' — ')
           .replace(/\.\s*$/gm,'。');
      // ありがちな見出し語を和訳風に
      t = t.replace(/^\s*・\s*(Introduction|Overview|Summary)\b.*$/gmi,'・要点:')
           .replace(/^\s*・\s*(Conclusion|Takeaways?)\b.*$/gmi,'・結論/要旨:')
           .replace(/^\s*・\s*(Background)\b.*$/gmi,'・背景:');
      // 先頭に日本語ラベル
      t = '【日本語要約】\n' + t;
      return t;
    }

    // 音声読み上げ
    function speakSummary(){
      const text = document.getElementById('summary').innerText.trim();
      if(!text){ alert('要約文がありません'); return; }
      if(speechSynthesis.speaking) speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      speechSynthesis.speak(utter);
    }

    // 初期化
    pickPreset(300);
  </script>
</body>
</html>
