<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æ–‡ç« è¦ç´„Bot</title>
  <link rel="apple-touch-icon" href="logo.jpg" />

  <style>
    :root{
      --bg:#0b1220; --surface:#0f1a33; --surface-2:#0b162e;
      --border:#1c2a4a; --text:#e8ecf1; --muted:#9fb1c7;
      --accent:#2a5bd7; --danger:#e35d5d;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin:0; padding:16px; line-height:1.6;
    }
    h1{font-size:1.25rem; margin:0 0 12px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:12px;
      padding:12px;
    }

    /* å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…¨æ–‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§è¦‹ãˆã‚‹ï¼‰ */
    #input{
      width:100%;
      height:40vh;                 /* ç”»é¢ã®4å‰²ã®é«˜ã• */
      resize:vertical;             /* å¿…è¦ãªã‚‰ãƒ‰ãƒ©ãƒƒã‚°ã§ä¼¸ç¸® */
      background:var(--surface-2);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      line-height:1.7;
      overflow:auto;               /* â† ãƒšãƒ¼ã‚¹ãƒˆå…¨æ–‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
      white-space:pre-wrap;
    }

    /* è¦ç´„çµæœï¼ˆé•·æ–‡ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */
    #summary{
      white-space:pre-wrap;
      background:var(--surface-2);
      border:1px solid var(--border);
      padding:12px; margin:12px 0; border-radius:10px;
      max-height:42vh;             /* ç”»é¢ã®ç´„4å‰²ã¾ã§è¡¨ç¤º */
      overflow:auto;               /* â† è¦ç´„ã‚‚å…¨æ–‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    }

    label{font-size:.95rem; color:var(--muted)}
    input[type="number"]{
      width:120px; padding:8px 10px;
      background:var(--surface-2); color:var(--text);
      border:1px solid var(--border); border-radius:8px;
    }
    .btn{
      background:var(--accent); color:#fff; border:none;
      padding:10px 14px; border-radius:10px; font-size:1rem;
    }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); }
    .btn.danger{ background:var(--danger); }
    .chip{
      border:1px solid var(--border); color:var(--text);
      background:transparent; padding:8px 10px; border-radius:999px; font-size:.95rem;
    }
    .chip[aria-pressed="true"]{ background:var(--surface-2); outline:2px solid var(--accent) }

    .hint{font-size:.85rem; color:var(--muted)}
    .small{font-size:.9rem}
  </style>
</head>
<body>
  <h1>æ–‡ç« è¦ç´„Bot</h1>

  <!-- ---- å…¥åŠ› ---- -->
  <div class="card" style="margin-bottom:12px">
    <div class="row" style="justify-content:space-between">
      <label class="small">ä¸‹ã«æœ¬æ–‡ã‚’ãƒšãƒ¼ã‚¹ãƒˆï¼ˆé•·æ–‡OKï¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ï¼‰</label>
      <button class="btn secondary small" onclick="pasteFromClipboard()">ğŸ“‹ ãƒšãƒ¼ã‚¹ãƒˆ</button>
    </div>
    <textarea id="input" placeholder="ã“ã“ã«è¨˜äº‹ã‚„æœ¬æ–‡ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘"></textarea>
  </div>

  <!-- ---- è¨­å®šï¼ˆé•·ã•æŒ‡å®šï¼‰---- -->
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <span class="hint">é•·ã•ï¼ˆç›®æ¨™æ–‡å­—æ•°ï¼‰:</span>
      <button class="chip" id="lenShort"  onclick="pickPreset(100)" aria-pressed="false">çŸ­: 50â€“100</button>
      <button class="chip" id="lenMid"    onclick="pickPreset(300)" aria-pressed="true">ä¸­: 200â€“400</button>
      <button class="chip" id="lenLong"   onclick="pickPreset(700)" aria-pressed="false">é•·: 600â€“800</button>
      <span class="hint">ï¼ ç›´æ¥æŒ‡å®š:</span>
      <input id="charLimit" type="number" min="30" max="2000" step="10" value="300" inputmode="numeric" pattern="[0-9]*" />
      <span class="hint">æ–‡å­—</span>
    </div>
    <div class="hint" style="margin-top:6px">
      æ•°å­—ä»¥å¤–ï¼ˆã€Œ2,00ã€ãªã©ï¼‰ã¯è‡ªå‹•ã§æ­£è¦åŒ–ã—ã¾ã™ã€‚å®Ÿéš›ã®è¦ç´„ã¯Â±10ã€œ15%ã®èª¤å·®ã‚’è¨±å®¹ã€‚
    </div>
  </div>

  <!-- ---- æ“ä½œ ---- -->
  <div class="row" style="margin-bottom:8px">
    <button class="btn" onclick="summarize()">ğŸ§  è¦ç´„ã™ã‚‹</button>
    <button class="btn secondary" onclick="clearAll()">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
    <button class="btn" onclick="speakSummary()">ğŸ”Š èª­ã¿ä¸Šã’</button>
  </div>

  <!-- ---- çµæœ ---- -->
  <div id="summary" aria-live="polite"></div>
  <div class="hint">â€» ãƒ‡ãƒ¢ç‰ˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§é•·ã•èª¿æ•´ã‚’å³å¯†åŒ–ã€‚æœ¬ç•ªAPIã§ã‚‚åŒã˜ç›®æ¨™æ–‡å­—æ•°ã‚’æ¸¡ã—ã€å®Œäº†å¾Œã«å¾®èª¿æ•´ã—ã¾ã™ã€‚</div>

  <script>
    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
    function sanitizeNumberLike(v){
      // å…¨è§’â†’åŠè§’ã€ã‚«ãƒ³ãƒãƒ»ç©ºç™½ã‚’é™¤å»ã—ã¦æ•°å€¤åŒ–
      const z2h = v.replace(/[ï¼-ï¼™ï¼Œã€ï¼ï¼\s]/g, s=>{
        const code = s.charCodeAt(0);
        if (s === 'ï¼Œ' || s === 'ã€' || s === ',') return '';
        if (s === 'ï¼' || s === 'ã€‚' || s === '.') return '';
        if (code >= 0xFF10 && code <= 0xFF19) return String.fromCharCode(code - 0xFF10 + 0x30);
        return '';
      }).replace(/[^\d]/g,'');
      return Number(z2h || 0);
    }
    function setPressed(id){
      ['lenShort','lenMid','lenLong'].forEach(k=>{
        document.getElementById(k).setAttribute('aria-pressed', k===id ? 'true' : 'false');
      });
    }
    function pickPreset(n){
      document.getElementById('charLimit').value = n;
      if (n<=120) setPressed('lenShort'); else if (n<=450) setPressed('lenMid'); else setPressed('lenLong');
    }

    async function pasteFromClipboard(){
      try{
        const text = await navigator.clipboard.readText();
        if(text){ document.getElementById('input').value = text; }
      }catch(e){
        alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚é•·æŠ¼ã—â†’ãƒšãƒ¼ã‚¹ãƒˆã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚');
      }
    }

    function clearAll(){
      document.getElementById('input').value = '';
      document.getElementById('summary').innerText = '';
    }

    // --- è¦ç´„ï¼ˆãƒ‡ãƒ¢ç”¨ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè£…ï¼‰ ---
    function summarize(){
      const raw = document.getElementById('input').value.trim();
      if(!raw){ alert('æœ¬æ–‡ã‚’ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„'); return; }

      // æ–‡å­—æ•°æŒ‡å®šã‚’æ­£è¦åŒ–ï¼ˆä¾‹: "2,00" â†’ 200ï¼‰
      const rawLimit = document.getElementById('charLimit').value.toString();
      let limit = Number(rawLimit);
      if(!Number.isFinite(limit) || limit<=0){
        limit = sanitizeNumberLike(rawLimit);
      }
      if(!limit || limit<30){ limit = 300; document.getElementById('charLimit').value = 300; }

      // ã“ã“ã§æœ¬æ¥ã¯APIè¦ç´„ã‚’å‘¼ã¶ï¼š
      // const ai = await callSummarizeAPI(raw, { targetChars: limit, style, ... });
      // ä»Šã¯ãƒ‡ãƒ¢ã¨ã—ã¦ã€æœ¬æ–‡ã‚’ã€Œæ®µè½â†’è¦ç‚¹æŠ½å‡ºâ†’æŒ‡å®šæ–‡å­—æ•°ã«è¿‘ã¥ã‘ã¦æ•´å½¢ã€
      const draft = heuristicSummarize(raw, limit);
      const tuned = lengthTuner(draft, limit);
      document.getElementById('summary').innerText = tuned;
    }

    // ã–ã£ãã‚Šè¦ç‚¹æŠ½å‡ºï¼ˆè¡Œé ­ã‚„ã€Œã€‚ã€ã€Œãƒ»ã€ã€Œ- ã€ãªã©ã‚’é ¼ã‚Šã«åˆ†å‰²â†’ä¸Šä½ã‚’æ¡ç”¨ï¼‰
    function heuristicSummarize(text, limit){
      // æ”¹è¡Œæ­£è¦åŒ–
      const t = text.replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n');
      // å€™è£œæ–‡ã®åˆ‡ã‚Šå‡ºã—
      let units = t
        .split(/(?<=[ã€‚ï¼ï¼Ÿ\?])\s+|\n- |\nãƒ»|\n|\t/g)
        .map(s=>s.trim()).filter(Boolean);

      // é‡è¤‡/ãƒã‚¤ã‚ºå‰Šã‚Š
      const seen = new Set();
      units = units.filter(s=>{
        const k = s.length>40 ? s.slice(0,40) : s;
        if(seen.has(k)) return false;
        seen.add(k);
        return s.length>1;
      });

      // çŸ­ã„è¦ç´ ã‚’ã¾ã¨ã‚ã¦ã‚¹ãƒ‹ãƒšãƒƒãƒˆåŒ–
      let out = '';
      for(const u of units){
        if(out.length + u.length + 1 > Math.max(1200, limit*3)) break; // éå‰°é€£çµé˜²æ­¢
        out += (out ? '\n' : '') + (u.startsWith('ãƒ»') || u.startsWith('-')? u : 'ãƒ»' + u);
      }
      if(!out) out = text.slice(0, Math.min(text.length, limit*2));
      return out;
    }

    // ç›®æ¨™æ–‡å­—æ•°ã«åˆã‚ã›ã¦å¾®èª¿æ•´ï¼ˆÂ±ç´„15%ã«åã‚ã‚‹ï¼‰
    function lengthTuner(text, target){
      const min = Math.round(target*0.85);
      const max = Math.round(target*1.15);

      // è¿‘ã„ãªã‚‰ãã®ã¾ã¾
      if(text.length>=min && text.length<=max) return text;

      if(text.length>max){
        // æ–‡ç« æœ«å°¾ï¼ˆå¥ç‚¹/æ”¹è¡Œï¼‰ã§æ°—æŒã¡ã‚ˆãåˆ‡ã‚‹
        const cut = smartCut(text, max);
        return cut;
      }else{
        // å°‘ãªã„ã¨ãï¼šå…ƒãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è¿½åŠ ã§å°‘ã—ç¶™ãè¶³ã™ã®ãŒæœ¬æ¥ã ãŒã€
        // ãƒ‡ãƒ¢ã§ã¯å†—é•·èªã‚’å°‘ã—è¶³ã—ã¦ä½“è£ã‚’æ•´ãˆã‚‹
        return padTo(text, min);
      }
    }

    function smartCut(text, max){
      if(text.length<=max) return text;
      const slice = text.slice(0, max);
      const p = Math.max(slice.lastIndexOf('ã€‚'), slice.lastIndexOf('\n'));
      return (p>0 ? slice.slice(0, p+1) : slice) + (p>0 ? '' : 'â€¦');
    }

    function padTo(text, min){
      if(text.length>=min) return text;
      const filler = '\nï¼ˆè¦ç‚¹ã‚’å‡ç¸®ã—ã¦ã„ã¾ã™ã€‚è©³ç´°ã¯åŸæ–‡ã‚’ã”ç¢ºèªãã ã•ã„ã€‚ï¼‰';
      let out = text + filler;
      if(out.length<min) out = out + ' è¿½è¨˜: æ¦‚è¦ã®ç¶²ç¾…ã‚’å„ªå…ˆã—ã€ç´°éƒ¨ã¯çœç•¥ã€‚';
      return out;
    }

    // --- éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆæ®ãˆç½®ãï¼‰ ---
    function speakSummary(){
      const text = document.getElementById('summary').innerText.trim();
      if(!text){ alert('è¦ç´„æ–‡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      // é€£ç¶šæŠ¼ä¸‹æ™‚ã«å‰ã®ç™ºè©±ã‚’æ­¢ã‚ã‚‹
      if(speechSynthesis.speaking) speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      speechSynthesis.speak(utter);
    }

    // åˆæœŸãƒœã‚¿ãƒ³çŠ¶æ…‹
    pickPreset(300);
  </script>
</body>
</html>
