<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æ–‡ç« è¦ç´„Bot</title>
  <link rel="apple-touch-icon" href="logo.jpg" />
  <style>
    :root{
      --bg:#0b1220; --surface:#0f1a33; --surface-2:#0b162e;
      --border:#1c2a4a; --text:#e8ecf1; --muted:#9fb1c7;
      --accent:#2a5bd7; --danger:#e35d5d;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      margin:0; padding:16px; line-height:1.6;
    }
    h1{font-size:1.25rem; margin:0 0 12px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:12px;
      padding:12px; margin-bottom:12px;
    }
    .hint{font-size:.85rem; color:var(--muted)}
    .small{font-size:.9rem}

    /* URLå…¥åŠ› */
    #urlInput{
      flex:1 1 220px; min-width:220px;
      padding:10px 12px; border-radius:10px;
      background:var(--surface-2); color:var(--text);
      border:1px solid var(--border);
    }

    /* å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå…¨æ–‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
    #input{
      width:100%; height:40vh; resize:vertical;
      background:var(--surface-2); color:var(--text);
      border:1px solid var(--border); border-radius:10px;
      padding:12px; line-height:1.7;
      overflow:auto; white-space:pre-wrap;
    }

    /* è¦ç´„çµæœï¼ˆå…¨æ–‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼‰ */
    #summary{
      white-space:pre-wrap; background:var(--surface-2);
      border:1px solid var(--border); border-radius:10px;
      padding:12px; max-height:42vh; overflow:auto;
    }

    input[type="number"]{
      width:120px; padding:8px 10px;
      background:var(--surface-2); color:var(--text);
      border:1px solid var(--border); border-radius:8px;
    }
    .btn{
      background:var(--accent); color:#fff; border:none;
      padding:10px 14px; border-radius:10px; font-size:1rem;
    }
    .btn.secondary{ background:transparent; color:var(--text); border:1px solid var(--border); }
    .btn.danger{ background:var(--danger); }

    /* ç¸¦ä¸¦ã³ãƒ—ãƒªã‚»ãƒƒãƒˆ */
    .presets{
      display:flex; flex-direction:column; gap:8px; width:160px;
    }
    .chip{
      width:100%;
      text-align:left;
      border:1px solid var(--border); color:var(--text);
      background:transparent; padding:10px 12px; border-radius:10px; font-size:.95rem;
    }
    .chip[aria-pressed="true"]{ background:var(--surface-2); outline:2px solid var(--accent) }
  </style>
</head>
<body>
  <h1>æ–‡ç« è¦ç´„Bot</h1>

  <!-- URLå…¥åŠ›ï¼†å–å¾—ï¼ˆå¿…ãšå…¥åŠ›æ¬„ã«æµã—è¾¼ã‚“ã§ã‹ã‚‰è¦ç´„ï¼‰ -->
  <div class="card">
    <div class="row">
      <input id="urlInput" type="url" placeholder="https:// ã‹ã‚‰å§‹ã¾ã‚‹è¦ç´„ã—ãŸã„ãƒšãƒ¼ã‚¸ã®URLã‚’è²¼ã‚Šä»˜ã‘" />
      <button class="btn" onclick="loadFromURL()">ğŸŒ URLã‚’è¦ç´„</button>
    </div>
    <div class="hint" style="margin-top:6px">
      æœ¬æ–‡æŠ½å‡ºã¯ <code>r.jina.ai</code> ã‚’å„ªå…ˆã€‚ãƒ–ãƒ­ãƒƒã‚¯æ™‚ã¯æœ¬æ–‡ã‚’ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚
    </div>
  </div>

  <!-- å…¥åŠ›ï¼ˆãƒšãƒ¼ã‚¹ãƒˆï¼‰ -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <label class="small">ä¸‹ã«æœ¬æ–‡ã‚’ãƒšãƒ¼ã‚¹ãƒˆï¼ˆé•·æ–‡OKï¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯ï¼‰</label>
      <button class="btn secondary small" onclick="pasteFromClipboard()">ğŸ“‹ ãƒšãƒ¼ã‚¹ãƒˆ</button>
    </div>
    <textarea id="input" placeholder="ã“ã“ã«è¨˜äº‹ã‚„æœ¬æ–‡ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘"></textarea>
  </div>

  <!-- è¨­å®šï¼ˆé•·ã•æŒ‡å®šï¼šç¸¦ä¸¦ã³ï¼‰ -->
  <div class="card">
    <div class="row" style="align-items:flex-start">
      <div class="presets">
        <button class="chip" id="lenShort"  onclick="pickPreset(100)" aria-pressed="false">çŸ­: 50â€“100 æ–‡å­—</button>
        <button class="chip" id="lenMid"    onclick="pickPreset(300)" aria-pressed="true">ä¸­: 200â€“400 æ–‡å­—</button>
        <button class="chip" id="lenLong"   onclick="pickPreset(700)" aria-pressed="false">é•·: 600â€“800 æ–‡å­—</button>
      </div>
      <div>
        <div class="hint">ç›´æ¥æŒ‡å®š:</div>
        <div class="row" style="margin-top:6px">
          <input id="charLimit" type="number" min="30" max="2000" step="10" value="300" inputmode="numeric" pattern="[0-9]*" />
          <span class="hint">æ–‡å­—</span>
        </div>
        <div class="hint" style="margin-top:6px">
          ã€Œ2,00ã€ã€Œï¼’ï¼ï¼ã€ãªã©ã¯è‡ªå‹•ã§æ•°å€¤åŒ–ã€‚ä»•ä¸ŠãŒã‚Šã¯ç›®æ¨™ã® Â±10ã€œ15% ã‚’ç›®å®‰ã«èª¿æ•´ã€‚
        </div>
      </div>
    </div>
  </div>

  <!-- æ“ä½œ -->
  <div class="row" style="margin-bottom:8px">
    <button class="btn" onclick="summarize()">ğŸ§  è¦ç´„ã™ã‚‹</button>
    <button class="btn secondary" onclick="clearAll()">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
    <button class="btn" onclick="speakSummary()">ğŸ”Š èª­ã¿ä¸Šã’</button>
  </div>

  <!-- çµæœ -->
  <div id="summary" aria-live="polite"></div>
  <div class="hint">â€» è‹±æ–‡ã¯ç”»é¢å´ã§ç°¡æ˜“å’Œæ–‡åŒ–ã—ã¾ã™ï¼ˆæœ¬ç•ªã¯APIã§å®Œå…¨å’Œè¨³ï¼‰ã€‚</div>

  <script>
    // ===== URL â†’ ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º â†’ å…¥åŠ›æ¬„ã¸æµã—è¾¼ã¿ â†’ è¦ç´„ =====
    async function loadFromURL(){
      const input = document.getElementById('urlInput').value.trim();
      const url = normalizeURL(input);
      if(!url){ alert('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

      const jinaEndpoint = "https://r.jina.ai/http://" + url.replace(/^https?:\/\//,'');
      try{
        const resp = await fetch(jinaEndpoint, { method:'GET' });
        if(resp.ok){
          const text = (await resp.text() || '').trim();
          if(text){
            document.getElementById('input').value = text;
            summarize();
            return;
          }
        }
        throw new Error('jinaå¤±æ•—');
      }catch(e){
        alert('æœ¬æ–‡å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚µã‚¤ãƒˆå´ã®åˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ¬æ–‡ã‚’ãƒšãƒ¼ã‚¹ãƒˆã—ã¦è¦ç´„ã—ã¦ãã ã•ã„ã€‚');
      }
    }

    function normalizeURL(str){
      if(!str) return '';
      let s = str.trim();
      if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
      try{ new URL(s); return s; }catch{ return ''; }
    }

    // ===== ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰è²¼ã‚Šä»˜ã‘ =====
    async function pasteFromClipboard(){
      try{
        const text = await navigator.clipboard.readText();
        if(text){ document.getElementById('input').value = text; }
      }catch(e){
        alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚é•·æŠ¼ã—â†’ãƒšãƒ¼ã‚¹ãƒˆã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚');
      }
    }

    // ===== UIãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function sanitizeNumberLike(v){
      const z2h = v.toString().replace(/[ï¼-ï¼™ï¼Œã€ï¼ï¼\s]/g, s=>{
        const code = s.charCodeAt(0);
        if (s === 'ï¼Œ' || s === 'ã€' || s === ',') return '';
        if (s === 'ï¼' || s === 'ã€‚' || s === '.') return '';
        if (code >= 0xFF10 && code <= 0xFF19) return String.fromCharCode(code - 0xFF10 + 0x30);
        return '';
      }).replace(/[^\d]/g,'');
      return Number(z2h || 0);
    }
    function setPressed(id){
      ['lenShort','lenMid','lenLong'].forEach(k=>{
        document.getElementById(k).setAttribute('aria-pressed', k===id ? 'true' : 'false');
      });
    }
    function pickPreset(n){
      document.getElementById('charLimit').value = n;
      if (n<=120) setPressed('lenShort'); else if (n<=450) setPressed('lenMid'); else setPressed('lenLong');
    }
    function clearAll(){
      document.getElementById('input').value = '';
      document.getElementById('summary').innerText = '';
    }

    // ===== è¦ç´„ï¼ˆå…¥åŠ›æ¬„â†’è¦ç´„ï¼‰ =====
    function summarize(){
      const raw = document.getElementById('input').value.trim();
      if(!raw){ alert('æœ¬æ–‡ã‚’ç”¨æ„ã—ã¦ãã ã•ã„ï¼ˆURLå–å¾— or ãƒšãƒ¼ã‚¹ãƒˆï¼‰'); return; }
      summarizeText(raw);
    }

    // ===== è¦ç´„ï¼ˆãƒ†ã‚­ã‚¹ãƒˆâ†’è¦ç´„ï¼‰ =====
    function summarizeText(raw){
      const rawLimit = document.getElementById('charLimit').value.toString();
      let limit = Number(rawLimit);
      if(!Number.isFinite(limit) || limit<=0) limit = sanitizeNumberLike(rawLimit);
      if(!limit || limit<30){ limit = 300; document.getElementById('charLimit').value = 300; }

      const base = heuristicSummarize(raw, limit);
      const tuned = lengthTuner(base, limit);
      const jp = forceJapanese(tuned, raw);

      document.getElementById('summary').innerText = jp;
    }

    // ã–ã£ãã‚Šè¦ç‚¹æŠ½å‡ºï¼ˆç®‡æ¡æ›¸ãé¢¨ï¼‰
    function heuristicSummarize(text, limit){
      const t = text.replace(/\r\n/g,'\n').replace(/\n{3,}/g,'\n\n');
      let units = t.split(/(?<=[ã€‚\.ï¼ï¼Ÿ\?])\s+|\n- |\nâ€¢ |\nãƒ»|\n|\t/g)
                   .map(s=>s.trim()).filter(Boolean);

      const seen = new Set();
      units = units.filter(s=>{
        const k = s.length>60 ? s.slice(0,60) : s;
        if(seen.has(k)) return false; seen.add(k);
        return s.length>1;
      });

      let out = '';
      for(const u of units){
        if(out.length + u.length + 1 > Math.max(1200, limit*3)) break;
        out += (out ? '\n' : '') + (u.match(/^[-â€¢ãƒ»]/) ? u.replace(/^[-â€¢]\s?/, 'ãƒ»') : 'ãƒ»' + u);
      }
      if(!out) out = text.slice(0, Math.min(text.length, limit*2));
      return out;
    }

    // ç›®æ¨™æ–‡å­—æ•°ã«åˆã‚ã›ã¦å¾®èª¿æ•´ï¼ˆÂ±ç´„15%ï¼‰
    function lengthTuner(text, target){
      const min = Math.round(target*0.85);
      const max = Math.round(target*1.15);
      if(text.length>=min && text.length<=max) return text;
      if(text.length>max) return smartCut(text, max);
      return padTo(text, min);
    }
    function smartCut(text, max){
      if(text.length<=max) return text;
      const slice = text.slice(0, max);
      const p = Math.max(slice.lastIndexOf('ã€‚'), slice.lastIndexOf('\n'), slice.lastIndexOf('. '));
      return (p>0 ? slice.slice(0, p+1) : slice) + (p>0 ? '' : 'â€¦');
    }
    function padTo(text, min){
      if(text.length>=min) return text;
      const filler = '\nï¼ˆè¦ç‚¹ã‚’å‡ç¸®ã—ã¦ã„ã¾ã™ã€‚è©³ç´°ã¯åŸæ–‡ã‚’ã”ç¢ºèªãã ã•ã„ã€‚ï¼‰';
      let out = text + filler;
      if(out.length<min) out = out + ' è¿½è¨˜: æ¦‚è¦ã®ç¶²ç¾…ã‚’å„ªå…ˆã—ã€ç´°éƒ¨ã¯çœç•¥ã€‚';
      return out;
    }

    // è‹±æ–‡ã£ã½ã„å ´åˆã¯è¦‹ãŸç›®ã‚’å’Œæ–‡åŒ–ï¼ˆç°¡æ˜“ãƒ»ç”»é¢å´ï¼‰
    function forceJapanese(summary, raw){
      const looksEnglish = /[A-Za-z]/.test(raw) && !/[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥]/.test(raw.slice(0,500));
      if(!looksEnglish) return summary;

      let t = summary;
      // è¨˜å·ãƒ»æ¥ç¶šã®å’Œæ–‡åŒ–
      t = t.replace(/\n-/g,'\nãƒ»')
           .replace(/:\s*/g,'ï¼š')
           .replace(/;\s*/g,'ï¼›')
           .replace(/ - /g,' â€” ')
           .replace(/\.\s*$/gm,'ã€‚');
      // ã‚ã‚ŠãŒã¡ãªè¦‹å‡ºã—èªã‚’å’Œè¨³é¢¨ã«
      t = t.replace(/^\s*ãƒ»\s*(Introduction|Overview|Summary)\b.*$/gmi,'ãƒ»è¦ç‚¹:')
           .replace(/^\s*ãƒ»\s*(Conclusion|Takeaways?)\b.*$/gmi,'ãƒ»çµè«–/è¦æ—¨:')
           .replace(/^\s*ãƒ»\s*(Background)\b.*$/gmi,'ãƒ»èƒŒæ™¯:');
      // å…ˆé ­ã«æ—¥æœ¬èªãƒ©ãƒ™ãƒ«
      t = 'ã€æ—¥æœ¬èªè¦ç´„ã€‘\n' + t;
      return t;
    }

    // éŸ³å£°èª­ã¿ä¸Šã’
    function speakSummary(){
      const text = document.getElementById('summary').innerText.trim();
      if(!text){ alert('è¦ç´„æ–‡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      if(speechSynthesis.speaking) speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'ja-JP';
      speechSynthesis.speak(utter);
    }

    // åˆæœŸåŒ–
    pickPreset(300);
  </script>
</body>
</html>
